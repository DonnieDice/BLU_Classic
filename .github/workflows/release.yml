name: Package and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - alpha
      - main
      - master # Triggers on pushes to these branches

env:
  CF_API_KEY: ${{ secrets.CF_API_KEY }}
  WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}
  WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
  GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Clone Project
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git user
        run: |
          git config --global user.name "donniedice"
          git config --global user.email "donniedice@protonmail.com"

      - name: Determine Release Type
        id: set_release_type
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME="${{ github.ref_name }}"
            if [[ "$TAG_NAME" == *"beta"* ]]; then
              echo "release_type=beta" >> $GITHUB_OUTPUT
            elif [[ "$TAG_NAME" == *"alpha"* ]]; then
              echo "release_type=alpha" >> $GITHUB_OUTPUT
            else
              echo "release_type=release" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.ref }}" == "refs/heads/alpha" ]]; then
            echo "release_type=alpha" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "release_type=release" >> $GITHUB_OUTPUT
          else
            echo "release_type=none" >> $GITHUB_OUTPUT
          fi
          echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Extract Version from TOC
        id: extract_version
        run: |
          # Try to get version from BLU_Classic.toc, fallback to tag name
          if [ -f "BLU_Classic.toc" ]; then
            version=$(grep -oP '^## Version: \K(.*)' BLU_Classic.toc || echo "${{ github.ref_name }}")
          else
            version="${{ github.ref_name }}"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Extract Changelog
        id: extract_changelog
        run: |
          if [ -f "docs/CHANGES.md" ]; then
            CHANGELOG=$(cat docs/CHANGES.md | head -50 | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
            echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT
          else
            echo "changelog=Check the commit history for changes" >> $GITHUB_OUTPUT
          fi
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" >> $GITHUB_OUTPUT

      - name: Package Addon
        uses: BigWigsMods/packager@master
        if: steps.set_release_type.outputs.release_type != 'none'
        with:
          release-type: ${{ steps.set_release_type.outputs.release_type }}

      - name: Send Discord Release Notification
        if: success() && steps.set_release_type.outputs.release_type == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const https = require('https');
            const payload = {
              "username": "BLU Release",
              "avatar_url": "https://raw.githubusercontent.com/donniedice/BLU/main/images/BLU_Logo.png",
              "embeds": [{
                "title": "ðŸŽ® BLU | Better Level-Up! - (Classic) - ${{ steps.extract_version.outputs.version }}",
                "description": "**Level up in style!** A new version of BLU has been released!\n\nðŸŽµ **What's New:**\n${{ steps.extract_changelog.outputs.changelog }}",
                "url": "https://github.com/donniedice/BLU/releases/tag/${{ steps.set_release_type.outputs.tag_name }}",
                "color": 5814783, // Greenish color from HEAD
                "thumbnail": {
                  "url": "https://raw.githubusercontent.com/donniedice/BLU/main/images/BLU_Logo.png"
                },
                "fields": [
                  {
                    "name": "ðŸ“¥ Downloads",
                    "value": "[CurseForge](https://www.curseforge.com/wow/addons/blu)\n[WoWInterface](https://www.wowinterface.com/downloads/info26465)\n[Wago.io](https://addons.wago.io/addons/vEGPgWK1)\n[GitHub](https://github.com/donniedice/BLU)",
                    "inline": true
                  },
                  {
                    "name": "ðŸŽ® Compatibility",
                    "value": "âœ… The War Within\nâœ… Classic Era\nâœ… Cataclysm\nâœ… MoP Remix", // From HEAD
                    "inline": true
                  },
                  {
                    "name": "ðŸ’¬ Support",
                    "value": "[Join Discord](https://discord.gg/N7kdKAHVVF)\n[Report Issues](https://github.com/donniedice/BLU/issues)", // From HEAD
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "RGX Mods - RealmGX Community",
                  "icon_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif"
                },
                "timestamp": "${{ steps.extract_changelog.outputs.timestamp }}"
              }]
            };
            
            const webhookUrl = new URL('${{ secrets.DISCORD_WEBHOOK }}');
            const options = {
              hostname: webhookUrl.hostname,
              path: webhookUrl.pathname + webhookUrl.search,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            };
            
            https.request(options, (res) => {
              console.log(`statusCode: ${res.statusCode}`);
            }).on('error', (error) => {
              console.error('Discord notification failed:', error);
            }).end(JSON.stringify(payload));

      - name: Send Discord Beta Notification
        if: success() && steps.set_release_type.outputs.release_type == 'beta'
        uses: actions/github-script@v7
        with:
          script: |
            const https = require('https');
            const payload = {
              "username": "BLU Beta",
              "avatar_url": "https://raw.githubusercontent.com/donniedice/BLU/main/images/BLU_Logo.png",
              "embeds": [{
                "title": "ðŸ§ª BLU Beta - ${{ steps.extract_version.outputs.version }}",
                "description": "A beta version of BLU | Better Level-Up! (Classic) is available for testing!\n\n**What's New:**\n${{ steps.extract_changelog.outputs.changelog }}",
                "color": 16744448,
                "fields": [
                  {
                    "name": "ðŸ“¥ Download Beta",
                    "value": "[CurseForge](https://www.curseforge.com/wow/addons/blu)\n[GitHub](https://github.com/donniedice/BLU/releases)"
                  }
                ],
                "footer": {
                  "text": "RGX Mods - Beta Build",
                  "icon_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif"
                },
                "timestamp": "${{ steps.extract_changelog.outputs.timestamp }}"
              }]
            };
            
            const webhookUrl = new URL('${{ secrets.DISCORD_WEBHOOK }}');
            const options = {
              hostname: webhookUrl.hostname,
              path: webhookUrl.pathname + webhookUrl.search,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            };
            
            https.request(options, (res) => {
              console.log(`statusCode: ${res.statusCode}`);
            }).on('error', (error) => {
              console.error('Discord notification failed:', error);
            }).end(JSON.stringify(payload));

      - name: Send Discord Alpha Notification
        if: success() && steps.set_release_type.outputs.release_type == 'alpha'
        uses: actions/github-script@v7
        with:
          script: |
            const https = require('https');
            const payload = {
              "username": "BLU Alpha",
              "avatar_url": "https://raw.githubusercontent.com/donniedice/BLU/main/images/BLU_Logo.png",
              "embeds": [{
                "title": "ðŸ”¬ BLU Alpha - ${{ steps.extract_version.outputs.version }}",
                "description": "Development build for testing: BLU | Better Level-Up! (Classic)\n\n**What's New:**\n${{ steps.extract_changelog.outputs.changelog }}",
                "color": 16711680,
                "footer": {
                  "text": "RGX Mods - Alpha Build",
                  "icon_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif"
                },
                "timestamp": "${{ steps.extract_changelog.outputs.timestamp }}"
              }]
            };
            
            const webhookUrl = new URL('${{ secrets.DISCORD_WEBHOOK }}');
            const options = {
              hostname: webhookUrl.hostname,
              path: webhookUrl.pathname + webhookUrl.search,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            };
            
            https.request(options, (res) => {
              console.log(`statusCode: ${res.statusCode}`);
            }).on('error', (error) => {
              console.error('Discord notification failed:', error);
            }).end(JSON.stringify(payload));

      - name: Send Discord Failure Notification
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const https = require('https');
            const payload = {
              "username": "BLU Build Failed",
              "avatar_url": "https://raw.githubusercontent.com/donniedice/BLU/main/images/BLU_Logo.png",
              "embeds": [{
                "title": "âŒ BLU Build Failed",
                "description": "The release workflow encountered an error",
                "url": "https://github.com/donniedice/BLU/actions/runs/${{ github.run_id }}",
                "color": 15158332,
                "fields": [
                  {
                    "name": "Version",
                    "value": "${{ steps.extract_version.outputs.version || 'Unknown' }}",
                    "inline": true
                  },
                  {
                    "name": "Workflow",
                    "value": "[View Logs](https://github.com/donniedice/BLU/actions/runs/${{ github.run_id }})",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "RGX Mods - Build System",
                  "icon_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif"
                },
                "timestamp": "${{ steps.extract_changelog.outputs.timestamp }}"
              }]
            };
            
            const webhookUrl = new URL('${{ secrets.DISCORD_WEBHOOK }}');
            const options = {
              hostname: webhookUrl.hostname,
              path: webhookUrl.pathname + webhookUrl.search,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            };
            
            https.request(options, (res) => {
              console.log(`statusCode: ${res.statusCode}`);
            }).on('error', (error) => {
              console.error('Discord notification failed:', error);
            }).end(JSON.stringify(payload));